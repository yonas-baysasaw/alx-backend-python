#!/bin/bash

# =========================================
# 🧱 Objective: Scale, Test & Monitor Django App on Kubernetes
# =========================================

DEPLOYMENT_NAME="messaging-app-deployment"
SERVICE_NAME="messaging-app-service"
NAMESPACE="default"

echo "🚀 Scaling $DEPLOYMENT_NAME to 3 replicas..."
kubectl scale deployment $DEPLOYMENT_NAME --replicas=3

echo
echo "⏳ Waiting for pods to be ready..."
kubectl rollout status deployment/$DEPLOYMENT_NAME

echo
echo "✅ Current Pods:"
kubectl get pods -l app=messaging-app

echo
echo "🌐 Getting Service URL..."
SERVICE_URL=$(minikube service $SERVICE_NAME --url)
echo "Your app is accessible at: $SERVICE_URL"

echo
echo "💥 Performing load test using wrk..."
echo "Running 15s test with 2 threads and 10 connections..."
wrk -t2 -c10 -d15s $SERVICE_URL

echo
echo "📊 Monitoring resource usage..."
kubectl top pods
